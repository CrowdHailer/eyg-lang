<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Device</title>
  </head>
  <body>
    <h1>Loading device</h1>
    <button onclick="handleConnect(event)">Connect to Serial</button>
    <input id="delay" type="number" size="1" value="2" />
    <script>
      const serial = navigator.serial; //|| exports.serial;
      const log = console.log;
      async function handleConnect(event) {
        event.preventDefault();
        const port = await connect();
        startReader(port);
        startWrite(port);
        log(port);
      }

      async function connect() {
        try {
          let port = await serial.requestPort({ filters: [] });
          window.x = port;
          console.log(port);
          log("Connected to serial port: " + JSON.stringify(port.getInfo()));
          // returns undefined
          await port.open({ baudRate: 57600 });
          log("Serial port opened");
          log(port.getInfo());

          return port;
        } catch (error) {
          log(error);
        }
      }

      async function startReader(port) {
        while (port.readable) {
          const reader = port.readable.getReader();
          log("readable", port.readable);
          try {
            while (true) {
              const { value, done } = await reader.read();
              log("done", done);
              if (done) {
                // Allow the serial port to be closed later.
                reader.releaseLock();
                break;
              }
              if (value) {
                // console.log(value);
                value.forEach((element) => {
                  console.log(element, element.toString(16));
                });
              }
            }
          } catch (error) {
            console.warn(error);
            // TODO: Handle non-fatal read error.
          }
        }
      }

      async function startWrite(port) {
        setTimeout(async () => {
          console.log("Starting write");
          const writer = port.writable.getWriter();

          const data = new Uint8Array([0xff, 0xf9]);
          const r = await writer.write(data);
          log("writes");
          log(r);

          // setTimeout(async () => {
          //   const data = new Uint8Array([0xf5, 13, 1]);
          //   const r = await writer.write(data);

          //   setTimeout(async () => {
          //     const data = new Uint8Array([0xf5, 13, 0]);
          //     const r = await writer.write(data);
          //   }, 5000);
          // }, 5000);
          await loop(writer);
          // Allow the serial port to be closed later.
          writer.releaseLock();
        }, 0);
      }

      async function freeze(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }
      async function loop(writer) {
        while (true) {
          delay = parseInt(document.getElementById("delay").value) * 100;
          console.log(delay);
          const on = new Uint8Array([0xf5, 13, 1]);
          await writer.write(on);
          await freeze(delay);
          const off = new Uint8Array([0xf5, 13, 0]);
          await writer.write(off);
          await freeze(delay);
        }
      }
    </script>
  </body>
</html>
