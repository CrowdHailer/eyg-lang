version: "3"

services:
  editor:
    build:
      context: .
      dockerfile: language.Dockerfile
    working_dir: /opt/app
    volumes:
      - .:/opt/app
    # network_mode unavailable on mac
    # network_mode: host
    # can't have port here because need to start two services
    command: "watchexec --exts gleam -- sh build_eyg"
  editor_frontend:
    image: node:16.5.0
    working_dir: /opt/app/editor
    volumes:
      - .:/opt/app
      # Need to use -p 5000:5000 for access via localhost
    ports:
      - "5000:5000"
    command: "npm run dev"

  language:
    build:
      context: .
      dockerfile: language.Dockerfile
    volumes:
      - .:/opt/app
    network_mode: host
    command: "watchexec --exts gleam -- gleam compile-package --src language/src --out public/gen --name my_app --target javascript"
  serve:
    build:
      context: .
      dockerfile: serve.Dockerfile
    volumes:
      - ./public:/opt/app
    network_mode: host
    command: "sirv . --dev --host 0.0.0.0"
